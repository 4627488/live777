<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="icon" href="./logo.svg" />
        <title>Live777</title>
        <style>
            fieldset {
                border-style: dotted;
                border-width: 0.25rem;
                border-radius: 0.5rem;
                padding: 0.5rem;
                margin: 0.5rem;
            }
        </style>
    </head>
    <body>
        <fieldset>
            <legend>Common</legend>
            <section style="display: flex;justify-content: space-evenly;flex-wrap: wrap;">
                <div>Resource ID: <input id="resource" type="text" /></div>
                <div>Bearer Token: <input id="token" type="text" /></div>
            </section>
        </fieldset>

        <div style="display: flex;justify-content: space-evenly;flex-wrap: wrap;">
            <fieldset>
                <legend>WHIP</legend>
                <button onclick="startWhip()"> WebRTC Start Whip</button>
            </fieldset>

            <fieldset>
                <legend>WHEP</legend>
                <button onclick="startWhep()"> WebRTC Start Whep</button>
            </fieldset>
        </div>
<br />
Video<br />
<div id="remoteVideos"></div> <br />

<section>
    <input type="checkbox" id="layer-check" />
    Layer: <select disabled id="layer-select"></select><br />
</section>

Logs<br />
<div id="div"></div>
<script src="./whip.js"></script>
<script src="./whep.js"></script>

<script>

        // Common
        const idResourceId = "resource"
        const idBearerToken = "token"

        function setURLSearchParams(k, v) {
            const params = new URLSearchParams((new URL(location.href)).search)
            !!v ? params.set(k, v) : params.delete(k)
            history.replaceState({}, "", "?" + params.toString())
        }
        function getURLSearchParams(k) {
            const params = new URLSearchParams((new URL(location.href)).search)
            return params.get(k)
        }
        function initCommonInput(elementId, paramId) {
            const element = document.getElementById(elementId)
            if (element) {
                element.addEventListener('input', ev => setURLSearchParams(paramId, ev.target.value))
                element.value = getURLSearchParams(paramId)
            }
        }
        initCommonInput(idResourceId, idResourceId)
        initCommonInput(idBearerToken, idBearerToken)

    const layers = [
        { rid: 'q', scaleResolutionDownBy: 4.0, scalabilityMode: 'L1T3' },
        { rid: 'h', scaleResolutionDownBy: 2.0, scalabilityMode: 'L1T3' },
        { rid: 'f', scalabilityMode: 'L1T3' }
    ]

    const idLayerCheck = "layer-check"
    const idLayerSelect = "layer-select"

    function initLayerCheck() {
        const checkLayer = document.getElementById(idLayerCheck)
        if (checkLayer) {
            const selectLayer = document.getElementById(idLayerSelect)
            if (selectLayer) {
                initLayerSelect(selectLayer)
                checkLayer.onchange = ev => {
                    if (ev.target.checked) {
                        selectLayer.disabled = false
                    } else {
                        selectLayer.disabled = true
                    }
                }
            }
        }
    }

    // @return Bool
    function getLayerCheck() {
        const checkLayer = document.getElementById(idLayerCheck)
        return checkLayer ? checkLayer.checked : false
    }

    // @params HTMLElementSelect
    function initLayerSelect(selectLayer) {
        const mapShow = {
            q: "LOW",
            h: "MEDIUM",
            f: "HIGH",
        }
        const opts = layers.map(i => {
            const opt = document.createElement("option")
            opt.value = i.rid
            opt.text = mapShow[i.rid]
            selectLayer.appendChild(opt)
        })
    }

    // @return String
    function getLayerSelect() {
        const selectLayer = document.getElementById(idLayerSelect)
        return selectLayer ? selectLayer.value : ""
    }

    initLayerCheck()

    async function startWhip() {
        const resource = document.getElementById("resource").value;
        if (!resource) {
            alert("input resource")
            return
        }
        const stream = await navigator.mediaDevices.getDisplayMedia({ audio: false, video: true })
        const pc = new RTCPeerConnection();

        let sendEncodings
        if (getLayerCheck()) {
            const layer = getLayerSelect()
            const index = layers.findIndex(i => i.rid === layer)
            sendEncodings = layers.slice(0 - (layers.length - index))
        } else {
            sendEncodings = []
        }
        pc.addTransceiver(stream.getVideoTracks()[0], {
            direction: 'sendonly',
            sendEncodings: sendEncodings,
        });
        const whip = new WHIPClient();
        const url = location.origin + "/whip/" + resource;
        const token = document.getElementById("token").value;
        await whip.publish(pc, url, token);

        document.getElementById(idLayerCheck).disabled = true
    }

    async function startWhep() {
        const resource = document.getElementById("resource").value;
        if (!resource) {
            alert("input resource")
            return
        }
        const pc = window.pc = new RTCPeerConnection();
        pc.addTransceiver('video', { 'direction': 'recvonly' })
        pc.addTransceiver('audio', { 'direction': 'recvonly' })
        pc.ontrack = (event) => {
            console.log(event)
            if (event.track.kind == "video") {
                var el = document.createElement(event.track.kind)
                el.srcObject = event.streams[0]
                el.autoplay = true
                el.controls = true
                document.getElementById('remoteVideos').appendChild(el)
            }
            if (event.track.kind == "audio") {
                var el = document.createElement(event.track.kind)
                el.srcObject = event.streams[0]
                el.autoplay = true
                el.controls = true
                document.getElementById('remoteVideos').appendChild(el)
            }
        }
        const whep = new WHEPClient();
        const url = location.origin + "/whep/" + resource;
        const token = document.getElementById("token").value;
        await whep.view(pc, url, token);

        const initEvevt = () => {
            const el = document.getElementById(idLayerSelect)
            if (el) el.onchange = ev => whep.selectLayer({"encodingId": ev.target.value})
        }

        if (whep.layerUrl) {
            const checkLayer = document.getElementById(idLayerCheck)
            const selectLayer = document.getElementById(idLayerSelect)
            if (checkLayer && selectLayer) {
                checkLayer.checked = true
                checkLayer.disabled = true
                selectLayer.disabled = false
            }
            initEvevt()
        }
        document.getElementById(idLayerCheck).disabled = true

    }

</script>
</body>
</html>
